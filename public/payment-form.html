<!DOCTYPE html>
<html>
<head>
  <title>Stripe Payment API</title>
  <script src="https://js.stripe.com/v3/"
  crossorigin="anonymous"></script>
</head>
<body>
  <form id="payment-form" , method="GET">
    <div class="form-row" height="3000px">
      <label for="card-element">Credit or debit card</label>
      <div id="card-element">
        <!-- A Stripe Element will be inserted here. -->
      </div>
      <div id="card-errors" role="alert" style="color: red;"></div>
    </div>
    <div id = "any_error"></div>
    <button type="submit">Submit Payment</button>
  </form>
  <h1 id = "paymentStatus"></h1>

  <script>
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiRGhhbnVyIFNoYXJtYSIsInVzZXJfaWQiOjgzLCJpYXQiOjE3MDE5MDQ0ODcsImV4cCI6MTcwMTkwODA4N30.LwCDKlO5ZVLcSONlhMsdeH19HT8-R4bg0WnrFzwkbY4';
    document.addEventListener('DOMContentLoaded', function() {
  const stripe = Stripe(
    'pk_test_51O7NOrDtd64NB5jL3sQrmsGQOSdMvTUpds9N0P7nfmT4697waURCZAmGs6vrIQjALewIeBpMJlDScO2NBr7h9ifN00J94KcMEj'
  ); // Publishable key

  // // get token from local storage
  // const token = localStorage.getItem('token');
  // console.log(token);
  

  // // get user id from local storage
  // const userID = localStorage.getItem('userID');
  // console.log(userID);

  // get cart from local storage
  // const cart = localStorage.getItem('cart');
  // console.log(cart);

  // get subTotalValue from local storage
  const subTotalValue = localStorage.getItem('subTotalValue');
  console.log(subTotalValue);

  const elements = stripe.elements();
  const cardElement = elements.create('card');

  cardElement.mount('#card-element');

  const form = document.getElementById('payment-form');
  const errorElement = document.getElementById('card-errors');

  form.addEventListener('submit', async function (event) {
  event.preventDefault();

  try {
    const { token, error } = await stripe.createToken(cardElement);

    if (error) {
      // Display error to the user
      errorElement.textContent = error.message;
      console.log(error.message);
    } else {
      // Clear any previous error message.
      console.log('paymentToken');
      console.log(token.id);

      errorElement.textContent = '';
      // Send the token to your server to complete the payment.
      try {
        const response = await fetch('http://localhost:3000/submit-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `${token}`
          },
          body: JSON.stringify({
            token: token.id,
            amount: subTotalValue
          }), // Amount comes from orders
        });

        const responseData = await response.json();
        console.log(responseData);

        document.getElementById("paymentStatus").innerHTML = "Payment Successful!";

        const authToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiRGhhbnVyIFNoYXJtYSIsInVzZXJfaWQiOjgzLCJpYXQiOjE3MDE5MDQ0ODcsImV4cCI6MTcwMTkwODA4N30.LwCDKlO5ZVLcSONlhMsdeH19HT8-R4bg0WnrFzwkbY4';
        const response2 = await fetch('http://localhost:3000/add-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `${authToken}`
          },
          body: JSON.stringify({
            userID: 83,
            orderAmount: subTotalValue,            
          })
        }
        );

        
      } catch (err) {
        document.getElementById("paymentStatus").innerHTML = "Payment Unsuccessful!";
        console.log(err);
      }
    }
  } catch (err) {
    console.error('Error creating token:', err);
  }
});



















  // form.addEventListener('submit', async function(event) {
  //   event.preventDefault();
  //   const {
  //     paymentToken,
  //     error
  //   } = await stripe.createToken(cardElement);
    
    
  //   if (error) {
  //     // Display error to user
  //     errorElement.textContent = error.message;
  //     console.log(error.message);
  //   } else {
  //     // Clear any previous error message.
  //     console.log('paymentToken');
  //     console.log(paymentToken.id);

  //     errorElement.textContent = '';
  //     // Send the token to your server to complete the payment.
  //     try {
  //       fetch('/submit-token', {
  //           method: 'POST',
  //           headers: {
  //             'Content-Type': 'application/json',
  //             'Authorization': `${token}`
  //           },
  //           body: JSON.stringify({
  //             token: paymentToken.id,
  //             amount: subTotalValue
  //           }), // Amount comes from orders
  //         })
  //         .then((response) => console.log(response.json()));
  //       document.getElementById("paymentStatus")
  //         .innerHTML = "Payment Successful!";
  //     } catch (err) {
  //       document.getElementById("paymentStatus")
  //         .innerHTML = "Payment Unsuccessful!";
  //     }
  //   }
  // });
});

  </script>
</body>
</html>
